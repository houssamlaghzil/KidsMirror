<!DOCTYPE html>
<html>
<head>
  <title>MagicMirrorÂ²</title>
  <meta name="google" content="notranslate" />
  <meta http-equiv="Content-type" content="text/html; charset=utf-8" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="mobile-web-app-capable" content="yes" />

  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <link rel="stylesheet" type="text/css" href="css/main.css" />
  <link rel="stylesheet" type="text/css" href="fonts/roboto.css" />
  <!-- custom.css is loaded by the loader.js to make sure it's loaded after the module css files. -->

  <script type="text/javascript">
    window.mmVersion = "#VERSION#";
  </script>
</head>
<body>
<div class="region fullscreen below"><div class="container"></div></div>
<div class="region top bar">
  <div class="container"></div>
  <div class="region top left"><div class="container"></div></div>
  <div class="region top center">
    <div class="container"></div>
  </div>
  <div class="region top right"><div class="container"></div></div>
</div>
<div class="region upper third"><div class="container"></div></div>
<div class="region middle center"><div class="container"></div></div>
<div class="region lower third">
  <div class="container"><br /></div>
</div>
<div class="region bottom bar">
  <div class="container" onclick="changeMode()">Change</div>
  <div class="region bottom left"><div class="container"></div></div>
  <div class="region bottom center"><div class="container"></div></div>
  <div class="region bottom right">
    <div id="gif"></div>
    <div class="container"></div>
  </div>
</div>
<div class="region fullscreen above"><div class="container"></div></div>

<div id="gameScreen" class="container hiddenItem">
  <div id="topGameScreen">
    <div id="score">
      <div id="scoreProgressBar" class="progressBar">
        <div style="width:0"></div>
      </div>
    </div>
    <div id="timer"></div>
    <div></div>
  </div>

  <div id="centerGameScreen">
    <div id="centerGameEmotion" class="hiddenItem">
      <div id="emotionToReproduct"></div>
      <div id="currentEmotion"></div>
    </div>
    <div id="centerGameDifficulty" class="hiddenItem">
      <div class="difficultySelect" onclick="gameObj.launchGame(1)">Facile</div>
      <div class="difficultySelect" onclick="gameObj.launchGame(2)">Moyen</div>
      <div class="difficultySelect" onclick="gameObj.launchGame(3)">Difficile</div>
    </div>
  </div>

  <div id="bottomGameScreen">
    <div></div>
    <div onclick="changeMode()">Quitter</div>
    <div></div>
  </div>
</div>

<script type="text/javascript" src="socket.io/socket.io.js"></script>
<script type="text/javascript" src="js/commonFunction.js"></script>
<script type="text/javascript" src="js/emotions.js"></script>
<script type="text/javascript" src="js/game.js"></script>
<script>
  let isGameMode = false
  let gameObj = new Game(document.getElementById("timer"), document.getElementById("scoreProgressBar"),document.getElementById("gameScreen"),
    document.getElementById("centerGameEmotion"), document.getElementById("centerGameDifficulty"))

  function changeMode(){
    isGameMode = !isGameMode
    if(isGameMode){
      gameObj.start()
    }
    else{
      gameObj.stopGame()
    }
  }
</script>

<script type="module">
  // import myJson from "./modules/MMM-Spotify/USERNAME_token.json" assert { type: "json" };

  const url = "https://api.spotify.com/v1/me/player";
  // const token = myJson.access_token;
  let emotion;
  let tab = [];
  let firstPlay = true;

  setInterval(async () => {
    if(!isGameMode) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          const obj = JSON.parse(this.responseText);
          emotion = obj[Math.floor(Math.random() * 5)].id;
          console.log(emotion);
          tab.push(emotion);
          if (tab.length == 3) {
            tab.shift();
          } else if (tab.length > 1) {
            firstPlay = false;
          }
          console.log(tab);
          console.log(firstPlay || tab[tab.length - 2] != tab[tab.length - 1]);
        }
      };
      xhttp.open("GET", "https://fakestoreapi.com/products", true);
      xhttp.send();

      if (firstPlay || tab[tab.length - 2] != tab[tab.length - 1]) {
        document.body.style = "background-image: url('" + emotionsObj[emotion].img + "');background-position: center;\n" +
          "  background-repeat: no-repeat;\n" +
          "  background-size: cover;"

      }
    }
  }, 2000);

  function doRequest(url, token, uri, index) {
    fetch(url + "/play", {
      method: "put",
      headers: new Headers({
        Authorization: "Bearer " + token,
        "Content-Type": "application/json"
      }),
      body: JSON.stringify({
        context_uri: uri,
        offset: {
          position: index
        },
        position_ms: 0
      })
    });
  }
  /*
        setTimeout(() => {
          fetch(url + "/devices", {
            method: "get",
            headers: new Headers({
              Authorization: "Bearer " + token,
              "Content-Type": "application/json"
            })
          })
            .then((response) => response.text())
            .then((data) => {
              const resp = JSON.parse(data);
              fetch(url, {
                method: "put",
                headers: new Headers({
                  Authorization: "Bearer " + token,
                  "Content-Type": "application/json"
                }),
                body: JSON.stringify({
                  device_ids: [resp.devices[0].id]
                })
              });
            });
        }, 2000);

        */

</script>
<script type="text/javascript" src="vendor/node_modules/nunjucks/browser/nunjucks.min.js"></script>
<script type="text/javascript" src="js/defaults.js"></script>
<script type="text/javascript" src="#CONFIG_FILE#"></script>
<script type="text/javascript" src="vendor/vendor.js"></script>
<script type="text/javascript" src="modules/default/defaultmodules.js"></script>
<script type="text/javascript" src="js/logger.js"></script>
<script type="text/javascript" src="translations/translations.js"></script>
<script type="text/javascript" src="js/translator.js"></script>
<script type="text/javascript" src="js/class.js"></script>
<script type="text/javascript" src="js/module.js"></script>
<script type="text/javascript" src="js/loader.js"></script>
<script type="text/javascript" src="js/socketclient.js"></script>
<script type="text/javascript" src="js/main.js"></script>

</body>
</html>
